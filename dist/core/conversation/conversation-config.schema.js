"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.DecommissionConfigSchema = exports.ServiceConversationConfigSchema = exports.CallTransferSchema = exports.BaseConversationConfigSchema = exports.ConversationStateHistorySchema = exports.ConversationMessageSchema = exports.ConversationDirection = exports.MessageSchema = exports.ConversationSummarySchema = void 0;
const zod_1 = require("zod");
const conversation_message_schema_1 = require("./conversation-message.schema");
const type_definitions_1 = require("../type-definitions");
/**
 * @fileoverview Conversation configuration schema definitions.
 *
 * Conversations represent individual interaction sessions between users and AI agents through various channels
 * (phone, SMS, web chat, email). They track message history, status progression, call metadata, and relationship
 * to deployment configurations. Each conversation is scoped to a project and organization.
 *
 * @module conversation/conversation-config
 */
/**
 * Conversation summary schema.
 *
 * AI-generated summary capturing the essence of a conversation including key discussion points,
 * required follow-up actions, and overall sentiment analysis. Generated post-conversation for
 * reporting, analytics, and customer service quality assurance.
 *
 * @remarks
 * **Architecture Context:**
 * - **Generated By**: Post-conversation AI summarization pipeline
 * - **Used For**: Analytics dashboards, quality assurance, and customer service reports
 * - **Stored In**: ServiceConversationConfig.conversationSummary field (optional)
 *
 * @typedef {Object} ConversationSummary
 * @property {string} summary - Concise 1-3 sentence overview of the entire conversation capturing main topics and outcomes
 * @property {string[]} key_points - Bullet points highlighting important discussion topics, decisions made, or information exchanged during the conversation
 * @property {string[]} action_items - Specific follow-up tasks, commitments, or next steps identified during the conversation (e.g., 'Send quote by Friday', 'Schedule follow-up call')
 * @property {string} sentiment - Overall emotional tone and customer satisfaction level detected from the conversation (POSITIVE, NEGATIVE, NEUTRAL, MIXED)
 */
exports.ConversationSummarySchema = zod_1.z.object({
    summary: zod_1.z.string().describe("Concise 1-3 sentence overview of the entire conversation capturing the main topics discussed, issues addressed, and final outcomes"),
    key_points: zod_1.z.array(zod_1.z.string()).describe("Array of bullet points highlighting important discussion topics, decisions made, information exchanged, or concerns raised during the conversation"),
    action_items: zod_1.z.array(zod_1.z.string()).describe("Array of specific follow-up tasks, commitments, or next steps identified during the conversation (e.g., 'Send pricing quote by Friday', 'Schedule technical support callback', 'Update account information')"),
    sentiment: zod_1.z.enum(type_definitions_1.ConversationSummarySentiment).describe("Overall emotional tone and customer satisfaction level detected from the conversation analysis (POSITIVE: satisfied/happy, NEGATIVE: frustrated/upset, NEUTRAL: informational, MIXED: varying emotions)")
});
/**
 * Message schema for conversation messages.
 *
 * Lightweight message representation used within conversation configurations. Simplified version
 * compared to the full ConversationMessageSchema for efficient storage and retrieval in conversation
 * message arrays.
 *
 * @remarks
 * **Architecture Context:**
 * - **Used In**: Conversation message arrays for quick access
 * - **Relationship**: Simplified version of full message schemas (UserChatMessage, AssistantChatMessage, etc.)
 * - **Storage**: Embedded within conversation documents for fast message loading
 *
 * @typedef {Object} Message
 * @property {string} [id] - Optional internal database ID for the message record
 * @property {string} messageId - Unique identifier for this message used for deduplication and reference (typically UUID)
 * @property {string} content - Text content of the message sent by user or assistant
 * @property {string} message_type - Type of message sender indicating who sent this message (user or assistant)
 * @property {Date} timestamp - JavaScript Date object representing when the message was created and sent
 * @property {Object} metadata - Additional message-specific metadata including attachments, formatting, media URLs, delivery status, or channel-specific attributes
 * @property {number} [created_at] - Unix timestamp in milliseconds when the message was created (for sorting and filtering)
 */
exports.MessageSchema = zod_1.z.object({
    id: zod_1.z.string().optional().describe("Optional internal database ID for the message record, auto-generated by the storage system"),
    messageId: zod_1.z.string().describe("Unique identifier for this message used for deduplication, reference tracking, and message threading (typically UUID format)"),
    content: zod_1.z.string().describe("Text content of the message sent by the user or assistant, may include plain text or formatted content depending on channel capabilities"),
    message_type: zod_1.z.enum(conversation_message_schema_1.MessageType).describe("Type of message sender indicating who sent this message: 'user' for customer messages, 'assistant' for AI agent responses"),
    timestamp: zod_1.z.date().describe("JavaScript Date object representing the exact time when the message was created and sent in the conversation"),
    metadata: zod_1.z.record(zod_1.z.string(), zod_1.z.any()).describe("Additional message-specific metadata as key-value pairs including attachments, formatting, media URLs, delivery status, read receipts, or channel-specific attributes"),
    created_at: zod_1.z.number().optional().describe("Unix timestamp in milliseconds when the message was created, used for chronological sorting and time-based filtering in queries")
});
/**
 * Conversation direction enum.
 */
var ConversationDirection;
(function (ConversationDirection) {
    ConversationDirection["INBOUND"] = "inbound";
    ConversationDirection["OUTBOUND"] = "outbound";
})(ConversationDirection || (exports.ConversationDirection = ConversationDirection = {}));
/**
 * Union of all conversation message types.
 */
exports.ConversationMessageSchema = zod_1.z.union([
    conversation_message_schema_1.UserChatMessageSchema,
    conversation_message_schema_1.AssistantChatMessageSchema,
    conversation_message_schema_1.UserEmailMessageSchema,
    conversation_message_schema_1.AssistantEmailMessageSchema
]);
/**
 * Conversation state history schema for tracking status changes.
 *
 * Audit trail recording each status transition throughout a conversation's lifecycle. Enables tracking
 * conversation progression from initiation to completion, understanding conversation flow patterns, and
 * analyzing resolution times.
 *
 * @remarks
 * **Architecture Context:**
 * - **Used In**: ServiceConversationConfig.state_history array
 * - **Purpose**: Audit trail for status transitions and conversation lifecycle tracking
 * - **Analytics**: Used for measuring average handling time, resolution rates, and conversation flow analysis
 *
 * **Status Lifecycle:**
 * - **ACTIVE**: Conversation currently in progress with ongoing message exchange
 * - **COMPLETED**: Conversation successfully concluded with issue resolved or information provided
 * - **FAILED**: Conversation encountered errors or technical failures
 * - **ABANDONED**: User left conversation without resolution
 * - **TRANSFERRED**: Call transferred to human agent
 *
 * @typedef {Object} ConversationStateHistory
 * @property {string} status - The conversation status at this point in the lifecycle (ACTIVE, COMPLETED, FAILED, ABANDONED, TRANSFERRED)
 * @property {number} timestamp - Unix timestamp in milliseconds when this status was set and recorded
 * @property {string} [reason] - Optional human-readable explanation for why the status changed (e.g., 'User requested transfer', 'Timeout after 5 minutes of inactivity', 'Issue resolved')
 * @property {Object} [metadata] - Additional context about the state change including triggering events, system metrics, or escalation details
 */
exports.ConversationStateHistorySchema = zod_1.z.object({
    status: zod_1.z.enum(type_definitions_1.ConversationStatus).describe("The conversation status at this point in the lifecycle (ACTIVE: in progress, COMPLETED: successfully concluded, FAILED: encountered errors, ABANDONED: user left, TRANSFERRED: escalated to human)"),
    timestamp: zod_1.z.number().describe("Unix timestamp in milliseconds when this status was set and recorded in the conversation history"),
    reason: zod_1.z.string().optional().describe("Optional human-readable explanation for why the status changed (e.g., 'User requested transfer to billing', 'Timeout after 5 minutes of inactivity', 'Issue successfully resolved')"),
    metadata: zod_1.z.record(zod_1.z.string(), zod_1.z.any()).optional().describe("Additional context about the state change as key-value pairs including triggering events, system metrics, agent performance data, or escalation/transfer details")
});
/**
 * Base conversation configuration schema.
 *
 * Foundation schema for all conversation types capturing the essential attributes of an interaction session
 * between a user and an AI agent. Conversations link to deployment configurations, track message history,
 * monitor status progression, and collect voice processing metadata for telephony interactions.
 *
 * @remarks
 * **Architecture Context:**
 * - **Relationship to Deployments**: N:1 - Multiple conversations use one deployment configuration
 * - **Relationship to Projects**: N:1 - Conversations are scoped to projects for organizational grouping
 * - **Relationship to Channels**: N:1 - Multiple conversations occur through one channel
 * - **Extended By**: ServiceConversationConfigSchema adds conversation-specific fields (id, call transfer, etc.)
 * - **Storage**: Primary conversation record with embedded messages for performance
 *
 * **Conversation Types:**
 * - **OTT_CHAT**: Over-the-top chat (web, mobile app messaging)
 * - **TELEPHONY_CALL**: Voice phone calls with STT/TTS processing
 * - **SMS**: Text message conversations
 * - **EMAIL**: Email-based interactions
 * - **WHATSAPP**: WhatsApp messaging conversations
 *
 * @typedef {Object} BaseConversationConfig
 * @property {string} channel_id - ID of the deployment channel through which this conversation is conducted (references DeploymentChannel)
 * @property {string} project_id - ID of the project this conversation is associated with for organizational grouping and access control (references Project)
 * @property {string} deployment_config_id - ID of the deployment configuration that powers this conversation (N:1 relationship, references DeploymentConfiguration)
 * @property {string} channel_identifier - Unique identifier for the specific communication endpoint (phone number in E.164 format, chat widget ID, email address, WhatsApp number)
 * @property {string} [instruction_config_id] - Optional ID of the instruction configuration overriding deployment defaults for this specific conversation (references InstructionConfiguration)
 * @property {string} [partner_user_id] - External partner or user identifier from integrated systems for cross-platform user tracking and CRM integration
 * @property {string} conversation_type - Type of conversation defining the communication channel and interaction mode (OTT_CHAT, TELEPHONY_CALL, SMS, EMAIL, WHATSAPP)
 * @property {string} [model_id] - AI model ID used for this conversation, may override deployment configuration model for A/B testing or specialized scenarios
 * @property {number} [user_id] - Internal platform user ID for authenticated users, null for anonymous conversations
 * @property {number} [created_at] - Unix timestamp in milliseconds when conversation was initiated (default: current time)
 * @property {Array} [messages] - Array of messages exchanged in this conversation for quick access without separate queries (embedded for performance)
 * @property {boolean} is_campaign - Flag indicating if this conversation is part of a marketing or outreach campaign (default: false for inbound conversations)
 * @property {string} [customer_id] - Customer or contact ID from CRM or external system for customer relationship tracking and conversation history aggregation
 * @property {string} [status] - Current operational status of the conversation (ACTIVE, COMPLETED, FAILED, ABANDONED, TRANSFERRED)
 * @property {number} durationInSeconds - Duration of the conversation in seconds for billing, analytics, and average handling time calculations (default: 15)
 * @property {string} [stt_model_id] - Speech-to-Text model ID used for voice conversations to transcribe user speech (e.g., 'whisper-v3', references WiilSupportModel)
 * @property {string} [tts_model_id] - Text-to-Speech model ID used for voice conversations to synthesize agent responses (e.g., 'eleven-labs-v2', references WiilSupportModel)
 * @property {Object} [conversationSummary] - Optional AI-generated summary of the conversation including key points, action items, and sentiment analysis (populated post-conversation)
 * @property {string} [created_day] - The day the conversation was created in YYYY-MM-DD format for daily aggregation queries and analytics partitioning
 * @property {Array} [state_history] - Historical audit trail of status changes throughout the conversation lifecycle for flow analysis and troubleshooting
 * @property {number} [updated_at] - Unix timestamp in milliseconds when conversation was last modified (message added, status changed, summary generated)
 * @property {number} [deleted_at] - Unix timestamp in milliseconds when conversation was soft-deleted, null if active (supports data retention policies)
 */
exports.BaseConversationConfigSchema = zod_1.z.object({
    channel_id: zod_1.z.string().describe("ID of the deployment channel through which this conversation is conducted (references DeploymentChannel for phone, SMS, web, or email configuration)"),
    organization_id: zod_1.z.string().describe("ID of the organization that owns this conversation for multi-tenant data isolation, access control, and billing attribution"),
    project_id: zod_1.z.string().describe("ID of the project this conversation is associated with for organizational grouping, reporting, and access control (N:1 relationship with Project)"),
    deployment_config_id: zod_1.z.string().describe("ID of the deployment configuration that powers this conversation including agent, instruction, and channel settings (N:1 relationship with DeploymentConfiguration)"),
    channel_identifier: zod_1.z.string().describe("Unique identifier for the specific communication endpoint: phone number in E.164 format (+12125551234), chat widget ID, email address, or WhatsApp number"),
    instruction_config_id: zod_1.z.string().optional().nullable().describe("Optional ID of the instruction configuration overriding deployment defaults for conversation-specific behavior or A/B testing (references InstructionConfiguration)"),
    partner_user_id: zod_1.z.string().optional().describe("External partner or user identifier from integrated systems (CRM, help desk, e-commerce) for cross-platform user tracking and unified customer view"),
    conversation_type: zod_1.z.enum(type_definitions_1.ServiceConversationType).describe("Type of conversation defining the communication channel and interaction mode (OTT_CHAT: web/mobile chat, TELEPHONY_CALL: voice, SMS: text, EMAIL: email, WHATSAPP: WhatsApp)"),
    model_id: zod_1.z.string().optional().describe("AI model ID used for this conversation, may override deployment configuration model for A/B testing, specialized scenarios, or model version upgrades (references WiilSupportModel)"),
    user_id: zod_1.z.number().optional().describe("Internal platform user ID for authenticated users enabling personalized conversations and user-specific history, null for anonymous or guest interactions"),
    created_at: zod_1.z.number().optional().default(Date.now).describe("Unix timestamp in milliseconds when conversation was initiated by user or outbound campaign (default: current time, used for chronological sorting)"),
    messages: zod_1.z.array(exports.ConversationMessageSchema).optional().nullable().describe("Array of messages exchanged in this conversation embedded for quick access without separate database queries (includes user and assistant messages with metadata)"),
    is_campaign: zod_1.z.boolean().default(false).describe("Flag indicating if this conversation is part of a marketing or outbound campaign (true) or an inbound customer-initiated interaction (false, default)"),
    customer_id: zod_1.z.string().optional().nullable().describe("Customer or contact ID from CRM or external system for customer relationship tracking, conversation history aggregation, and personalization"),
    status: zod_1.z.enum(type_definitions_1.ConversationStatus).nullable().optional().describe("Current operational status of the conversation (ACTIVE: ongoing, COMPLETED: concluded successfully, FAILED: errors, ABANDONED: user left, TRANSFERRED: escalated to human)"),
    durationInSeconds: zod_1.z.number().nonnegative().optional().default(15).describe("Duration of the conversation in seconds for billing calculations, analytics reporting, and average handling time (AHT) metrics (default: 15 for minimum billing)"),
    stt_model_id: zod_1.z.string().optional().nullable().describe("Speech-to-Text model ID used for voice conversations to transcribe user speech into text (e.g., 'whisper-v3', 'google-stt-enhanced', references WiilSupportModel)"),
    tts_model_id: zod_1.z.string().optional().nullable().describe("Text-to-Speech model ID used for voice conversations to synthesize agent text responses into natural speech (e.g., 'eleven-labs-v2', 'azure-neural-tts', references WiilSupportModel)"),
    conversationSummary: exports.ConversationSummarySchema.nullable().optional().describe("Optional AI-generated summary of the conversation including key discussion points, action items, and sentiment analysis (populated post-conversation for reporting and QA)"),
    created_day: zod_1.z.string().optional().describe("The day the conversation was created in YYYY-MM-DD ISO format for efficient daily aggregation queries, analytics partitioning, and time-series reporting"),
    state_history: zod_1.z.array(exports.ConversationStateHistorySchema).nullable().optional().describe("Historical audit trail of status changes throughout the conversation lifecycle for flow analysis, troubleshooting, and measuring time-to-resolution"),
    updated_at: zod_1.z.number().optional().nullable().describe("Unix timestamp in milliseconds when conversation was last modified (message added, status changed, summary generated, metadata updated) for change tracking"),
    deleted_at: zod_1.z.number().optional().nullable().describe("Unix timestamp in milliseconds when conversation was soft-deleted for data retention compliance, null if active (enables GDPR right-to-be-forgotten while preserving analytics)")
});
/**
 * Call transfer schema for tracking call transfer details in telephony conversations.
 *
 * Captures metadata about call transfers to human agents including transfer type, timing, destination,
 * and outcome. Used for measuring transfer rates, analyzing escalation patterns, and tracking agent
 * handoff performance in telephony deployments.
 *
 * @remarks
 * **Architecture Context:**
 * - **Used In**: ServiceConversationConfig.call_transfer field for telephony conversations
 * - **Triggered By**: Agent detecting escalation keywords, user request, or configured transfer conditions
 * - **References**: CallTransferConfig from agent configuration for transfer destinations
 * - **Analytics**: Used for measuring AI containment rates and identifying improvement areas
 *
 * **Transfer Types:**
 * - **blind**: Immediate unattended transfer without agent introduction (faster, no screening)
 * - **warm**: Attended transfer where agent is briefed before caller is connected (professional, allows declining)
 *
 * **Transfer Lifecycle:**
 * - **pending**: Transfer initiated, waiting for recipient to answer
 * - **completed**: Transfer successful, caller connected to human agent
 * - **failed**: Transfer failed due to busy line, no answer, or technical error
 * - **returned**: Call returned to AI agent after human agent consultation
 */
exports.CallTransferSchema = zod_1.z.object({
    transfer_type: zod_1.z.enum(['blind', 'warm']).nullable().optional().describe("Type of call transfer: 'blind' for immediate unattended transfer without introduction (faster), 'warm' for attended transfer with agent briefing before connection (professional, allows screening)"),
    transfer_target: zod_1.z.string().describe("Target phone number for the call transfer in E.164 format (e.g., '+12125551234') or internal extension identifier, must match CallTransferConfig.transfer_number"),
    transfer_initiated_at: zod_1.z.number().optional().describe("Unix timestamp in milliseconds when the transfer was initiated by the AI agent, used for measuring time-to-transfer and transfer latency"),
    transfer_completed_at: zod_1.z.number().optional().describe("Unix timestamp in milliseconds when the transfer was successfully completed with caller connected to human agent, used for calculating transfer duration"),
    transfer_status: zod_1.z.enum(['pending', 'completed', 'failed', 'returned']).describe("Current status of the call transfer (pending: initiated awaiting answer, completed: successful connection, failed: no answer/busy/error, returned: call returned to AI after consultation)"),
    transfer_reason: zod_1.z.string().optional().describe("Reason for the transfer as extracted from the conversation context (e.g., 'Billing inquiry requiring account access', 'Customer requested human agent', 'Technical issue beyond AI scope')")
});
/**
 * Service conversation configuration schema.
 *
 * Complete conversation record extending base configuration with conversation-specific identifiers,
 * provider metadata, call direction, recording URLs, and transfer details. This is the primary
 * schema used for storing and retrieving conversation records in the system.
 *
 * @remarks
 * **Architecture Context:**
 * - **Extends**: BaseConversationConfigSchema with conversation-specific fields
 * - **Storage**: Primary conversation entity in database with unique id
 * - **Provider Integration**: Tracks external provider IDs for email services, telephony platforms
 * - **Call Recordings**: resource_url links to call recording storage for compliance and quality assurance
 *
 * **Use Cases:**
 * - Creating new conversations for inbound/outbound interactions
 * - Retrieving conversation history with full message arrays
 * - Analyzing call recordings and transfer patterns
 * - Integrating with external email providers (Gmail, Outlook, etc.)
 */
exports.ServiceConversationConfigSchema = exports.BaseConversationConfigSchema.safeExtend({
    id: zod_1.z.string().describe("Unique identifier for this conversation record (typically UUID), used as primary key for database queries and cross-system references"),
    record_id: zod_1.z.string().optional().nullable().describe("Optional external record ID for integration with partner systems, CRM platforms, or help desk software for conversation linkage and data synchronization"),
    provider_message_id: zod_1.z.string().optional().nullable().describe("Provider-specific email message ID from email service providers (Gmail message ID, Outlook message ID, SendGrid ID) for email conversation tracking and threading"),
    direction: zod_1.z.enum(ConversationDirection).nullable().optional().describe("Direction of the telephony call: 'inbound' for customer-initiated calls, 'outbound' for agent-initiated or campaign calls (null for non-voice channels like chat/email)"),
    resource_url: zod_1.z.string().nullable().optional().describe("Resource URL for the call recording or conversation details from telephony provider (SignalWire recording URL, Twilio media URL) for compliance, quality assurance, and dispute resolution"),
    call_transfer: exports.CallTransferSchema.nullable().optional().describe("Call transfer details if the conversation was transferred to a human agent including transfer type, destination, timing, and outcome (null if no transfer occurred)")
});
/**
 * Decommission configuration schema.
 *
 * Request payload for decommissioning and shutting down active conversation services. Used for
 * gracefully terminating conversation sessions, cleaning up resources, and releasing telephony
 * connections when deployments are disabled or conversations are force-closed.
 *
 * @remarks
 * **Architecture Context:**
 * - **Used For**: Graceful shutdown of active conversation sessions
 * - **Triggered By**: Admin actions, deployment deactivation, or timeout policies
 * - **Effects**: Releases telephony resources, closes WebSocket connections, archives conversation
 *
 * **Use Cases:**
 * - Emergency shutdown of misbehaving conversation sessions
 * - Cleanup when deployments are deactivated
 * - Forced conversation termination for policy violations
 */
exports.DecommissionConfigSchema = zod_1.z.object({
    decommission_service_id: zod_1.z.string().describe("Service ID of the active conversation session to decommission and shut down gracefully, releases resources and closes all active connections"),
});
